var config=require("../config/const");const message=require("message"),request=require("/request"),Promisify=require("module/es6-Promise");import{setStorage,getStorage}from"wxApi";const serverUUIDList=["0000FFF0-0000-1000-8000-00805F9B34FB","0000FFF1-0000-1000-8000-00805F9B34FB","0000FFF2-0000-1000-8000-00805F9B34FB"];function once(e,o){var t;return function(){return e&&(t=e.apply(o||this,arguments),e=null),t}}function openAdapter(){return new Promisify((e,o)=>{wx.openBluetoothAdapter({success:e,fail:o})})}function closeAdapter(){return new Promisify((e,o)=>{wx.closeBluetoothAdapter({success:resolce,reject:o})})}function requestBLEName(e){var o={url:config.BASE_URL.URL_BLE_INFO,data:{bike_number:e,appkey:config.appkey}};return new Promisify((e,t)=>{wx.request({url:o.url,method:"GET",data:o.data,success:o=>{e(o)},fail:e=>{t(e)}})})}function openBLEDiscovery(){return new Promisify((e,o)=>{wx.startBluetoothDevicesDiscovery({services:[serverUUIDList[0]],allowDuplicatesKey:!0,success:e,fail:o})})}function closeBLEDiscovery(){return new Promisify((e,o)=>{wx.stopBluetoothDevicesDiscovery({success:e,fail:o})})}var onceOnBluetoothDeviceFound=once(function(){console.log("如果多次打印就休息"),wx.onBluetoothDeviceFound(function(e){console.log("发现新设备",e);var o=e.devices[0];getTargetBLEDevice(o)})}),getTargetBLEDevice=function(e){try{var o=e.name?e.name.slice(0,8):"",t=e.localName?e.localName(0,8):""}catch(e){}var c=getStorage("BLEName");o===c||t===c?(console.log("找到目标蓝牙锁",e),setStorage("IS_BLE_TARGET",!0),setStorage("BLEInfo",e),closeBLEDiscovery().then(function(e){console.log("关闭蓝牙扫描",e)}).catch(e=>{console.log("关闭蓝牙扫描错误",e)})):setStorage("IS_BLE_TARGET",!1)},connectBLE=function(){return new Promisify((e,o)=>{var t=getStorage("BLEInfo");console.log("尝试连接蓝牙",t),wx.createBLEConnection({deviceId:t.deviceId,success:resolce,fail:o})})};module.exports={requestBLEName:requestBLEName,openAdapter:openAdapter,closeAdapter:closeAdapter,openBLEDiscovery:openBLEDiscovery,closeBLEDiscovery:closeBLEDiscovery,onceOnBluetoothDeviceFound:onceOnBluetoothDeviceFound,connectBLE:connectBLE};